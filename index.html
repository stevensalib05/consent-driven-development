<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weldon Seat Sonar ‚Äî Hostile UX Edition</title>
<style>
  :root{
    --bg:#0b1117; --card:#101821; --muted:#2a3a47; --text:#cfe6ff;
    --green:#57dba1; --red:#ff6b6b; --yellow:#ffd166; --blue:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;z-index:3;background:#0d1420cc;backdrop-filter:blur(6px);
    border-bottom:1px solid #0f1a26}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
  h1{margin:0;font-size:clamp(18px,2.4vw,24px);letter-spacing:.2px}
  .badge{font-size:12px;border:1px dashed var(--muted);padding:4px 8px;border-radius:999px;opacity:.8}
  .marq{white-space:nowrap;overflow:hidden;border-top:1px dashed #1a2a3a}
  .marq span{display:inline-block;padding:6px 0;animation:marq 16s linear infinite;color:#8fb8ff}
  @keyframes marq{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  main{max-width:1200px;margin:16px auto 90px;padding:0 14px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .card{background:var(--card);border:1px solid #14202b;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .pane{padding:14px}
  video,canvas{width:100%;height:auto;display:block;background:#000;border-bottom:1px solid #233142}
  .legend{display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px;border-top:1px dashed #233242}
  .chip{display:inline-flex;gap:8px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #253645;background:#17222d;font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.green{background:var(--green)} .dot.red{background:var(--red)} .dot.blue{background:var(--blue)}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px;border-top:1px solid #172532;background:#0e1620;position:relative}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#18232e;border:1px solid #253645;border-radius:999px;padding:6px 10px}
  label.small{font-size:12px;opacity:.85}
  button,select,input[type="file"]::file-selector-button{
    background:#1a2630;color:var(--text);border:1px solid var(--muted);
    border-radius:10px;padding:8px 12px;cursor:pointer
  }
  button:hover{background:#223140}
  button.primary{background:#254055;border-color:#2f536d}
  input[type="range"]{accent-color:#6fc5ff}
  /* Hostile UX: reversed slider visuals */
  .reverse{transform:scaleX(-1)} .reverse + span{user-select:none}
  /* Floating tips that get in the way */
  .floaty{position:absolute;right:10px;top:-12px;background:#15202b;border:1px solid #243545;
    padding:6px 10px;border-radius:8px;font-size:12px;animation:float 6s ease-in-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(10px)}100%{transform:translateY(0)}}
  /* Annoy mode jiggle */
  .jiggle:hover{transform:translate(2px,-2px) rotate(-1deg)}
  .shaky{animation:shaky .25s infinite}
  @keyframes shaky{0%{transform:translate(0,0)}25%{transform:translate(1px,-1px)}50%{transform:translate(-1px,1px)}75%{transform:translate(1px,1px)}100%{transform:translate(0,0)}}
  /* Toasts */
  #toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:5}
  .toast{background:#0e1622;border:1px solid #213244;border-radius:12px;padding:10px 12px;min-width:220px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .ok{color:var(--green)} .warn{color:var(--yellow)} .err{color:var(--red)} .muted{opacity:.65}
  footer{position:fixed;bottom:0;left:0;right:0;padding:10px 14px;background:#0a0f14e0;backdrop-filter:blur(8px);
    border-top:1px solid #12202c;display:flex;gap:12px;justify-content:center}
  .kbd{background:#111a22;border:1px solid #2a3a47;border-radius:6px;padding:0 6px;font-size:12px}
  /* Mystery progress that means nothing */
  .mystery{height:6px;background:#12202c}
  .mystery>i{display:block;height:100%;width:12%;background:linear-gradient(90deg,#1e88e5,#7c4dff);animation:bar 2.6s linear infinite}
  @keyframes bar{0%{margin-left:-12%}100%{margin-left:100%}}
  /* Modal */
  .modalBack{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:6}
  .modal{background:#0f1620;border:1px solid #244;color:var(--text);padding:16px;border-radius:12px;max-width:420px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
<!-- TensorFlow.js + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
</head>
<body>
<header>
  <div class="bar">
    <h1>Weldon Seat Sonar <span class="badge">Hostile UX Edition‚Ñ¢</span></h1>
    <div class="row muted">Pings when it sees <b>occupied chairs</b>. Probably.</div>
  </div>
  <div class="mystery"><i></i></div>
  <div class="marq"><span>Tip: For best results, point at a chair. Not your shoes. ‚Ä¢ Your camera never leaves your device (unless you yeet your device). ‚Ä¢ If anything breaks, it‚Äôs a feature.</span></div>
</header>

<main class="grid">
  <section class="card">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div class="legend">
      <span class="chip"><span class="dot green"></span> empty chair</span>
      <span class="chip"><span class="dot red"></span> occupied chair</span>
      <span class="chip"><span class="dot blue"></span> person</span>
      <span class="chip muted">FPS: <span id="fps">0</span></span>
      <span class="chip muted">Model: COCO-SSD</span>
    </div>
    <div class="controls">
      <div class="floaty">Start requires <b>two</b> clicks. For safety.</div>
      <input type="checkbox" id="consent">
      <label for="consent" class="small">I solemnly swear this camera points at chairs*</label>
      <button id="start" class="primary jiggle">Do Not Press</button>
      <button id="stop" class="jiggle">Abort Mission</button>
      <select id="cameras" title="mystery camera"></select>

      <div class="pill">
        <label class="small">Confidence (reversed for no reason)</label>
        <input id="conf" type="range" class="reverse" min="0.2" max="0.9" step="0.05" value="0.5" />
        <span id="confv">0.50</span>
      </div>
      <div class="pill">
        <label class="small">Dramatic pause</label>
        <input id="cool" type="range" min="500" max="5000" step="100" value="1500" />
        <span id="coolv">1.5s</span>
      </div>
      <div class="pill">
        <label class="small">Sound</label>
        <input type="file" id="sound" accept="audio/*" />
        <span class="muted small">defaults to sonar</span>
      </div>
      <button id="mute">Mute (?)</button>
      <button id="snapshot">Take Evidence</button>
      <div class="pill">
        <label class="small">Annoy Mode</label>
        <input type="checkbox" id="annoy">
      </div>
      <div class="pill">
        <label class="small">Night Vision</label>
        <input type="checkbox" id="invert">
      </div>
    </div>
  </section>

  <aside class="card pane">
    <h3 style="margin-top:6px">Decision ‚Äúlogic‚Äù (trust us bro)</h3>
    <ol class="muted">
      <li>Detect <b>chair</b> + <b>person</b> in-browser.</li>
      <li>Chair is <b>occupied</b> if IoU ‚â• 0.25 with a person, or a person‚Äôs center falls inside the chair box.</li>
      <li>Otherwise it‚Äôs <b>empty</b>. We ping when there‚Äôs at least one <b>occupied</b> chair (respecting cooldown).</li>
    </ol>
    <hr style="border-color:#1a2a36;margin:14px 0">
    <div class="row"><b>Status:</b>&nbsp;<span id="status" class="warn">Model loading‚Ä¶</span></div>
    <div class="row"><b>Empty chairs:</b>&nbsp;<span id="emptyCount">0</span></div>
    <div class="row"><b>Occupied chairs:</b>&nbsp;<span id="occCount">0</span></div>
    <div class="row"><b>Persons:</b>&nbsp;<span id="personCount">0</span></div>
    <p class="muted" style="margin-top:10px">
      * By checking the box you agree to the Weldon Seat Sonar End-User License of Vibes (EULV).
    </p>
  </aside>
</main>

<footer class="muted">
  Keys: <span class="kbd">S</span> start/stop ‚Ä¢ <span class="kbd">Q</span> mute/unmute ‚Ä¢ <span class="kbd">Space</span> ping ‚Ä¢ <span class="kbd">F</span> fullscreen
</footer>

<div id="toasts"></div>

<!-- modal that appears at wildly unhelpful times -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <h3>Are you sure you meant to click that?</h3>
    <p class="muted">Double-confirm to continue. Triple-confirm to cancel the confirm.</p>
    <div class="row" style="justify-content:flex-end">
      <button id="mCancel">Triple-Confirm (Cancel)</button>
      <button id="mOk" class="primary">Double-Confirm</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ==== Elements & state ====
  const els = {
    video: document.getElementById('video'),
    overlay: document.getElementById('overlay'),
    start: document.getElementById('start'),
    stop: document.getElementById('stop'),
    cameras: document.getElementById('cameras'),
    conf: document.getElementById('conf'),
    confv: document.getElementById('confv'),
    cool: document.getElementById('cool'),
    coolv: document.getElementById('coolv'),
    sound: document.getElementById('sound'),
    mute: document.getElementById('mute'),
    snapshot: document.getElementById('snapshot'),
    fps: document.getElementById('fps'),
    emptyCount: document.getElementById('emptyCount'),
    occCount: document.getElementById('occCount'),
    personCount: document.getElementById('personCount'),
    status: document.getElementById('status'),
    consent: document.getElementById('consent'),
    toasts: document.getElementById('toasts'),
    annoy: document.getElementById('annoy'),
    invert: document.getElementById('invert'),
    modalBack: document.getElementById('modalBack'),
    mOk: document.getElementById('mOk'),
    mCancel: document.getElementById('mCancel')
  };
  let model = null, stream = null, running = false, ctx = els.overlay.getContext('2d');
  let muted = false, lastPing = 0, cooldown = 1500, startClicks = 0;
  let animId = 0, lastT = performance.now(), frames = 0;
  let audioUnlocked = false;

  // ==== Audio ====
  // List of default sounds in /audio
  const soundFiles = [
    'audio/fahhh.mp3',
    'audio/metal-pipe.mp3',
    'audio/oof.mp3',
    'audio/sonar.mp3',
    'audio/vine-boom.mp3',
    'audio/67.mp3',
    'audio/job.mp3',
    'audio/discord-ping.mp3',
    'audio/airhorn.mp3', 
    'audio/sudden.mp3', 
    'audio/suspense.mp3', 
    'audio/r2d2.mp3',
    'audio/bruh.mp3',
    'audio/mgs.mp3', 
    'audio/FBI.mp3',
    // add more here as needed
  ];

  // Turn them into Audio objects
  let audioBank = soundFiles.map(src => {
    const a = new Audio(src);
    a.preload = 'auto';
    return a;
  });
  
  function unlockAudio(){
    if (audioUnlocked) return;
    audioUnlocked = true;

    // Prime ALL sounds (for iOS/Safari weirdness)
    audioBank.forEach(a => {
      a.volume = 1;
      a.play()
        .then(() => {
          a.pause();
          a.currentTime = 0;
          a.volume = 10;
        })
        .catch(() => { /* shrug */ });
    });
  }

  function getRandomAudio() {
    if (!audioBank.length) return null;
    return audioBank[Math.floor(Math.random() * audioBank.length)];
  }

  function playPing(){
    if (muted) return;
    const now = performance.now();
    if (now - lastPing < cooldown) return;
    lastPing = now;

    const base = getRandomAudio();
    if (base) {
      const instance = base.cloneNode(true);
      // optional extra chaos:
      instance.playbackRate = 0.8 + Math.random() * 0.6;
      
      instance.play().catch(() => synthPing());
    } else {
      synthPing();
    }

    toast('üîî Occupied chair detected', 'ok');
  }

  function synthPing(){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    const ac = new Ctx();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = 'sine'; 
    o.frequency.setValueAtTime(900, ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(500, ac.currentTime + 0.18);
    g.gain.setValueAtTime(0.05, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.18);
    o.connect(g).connect(ac.destination);
    o.start(); 
    o.stop(ac.currentTime + 0.18);
  }

  // File input: replaces bank with a single custom sound
  els.sound.addEventListener('change', () => {
    const file = els.sound.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const custom = new Audio(url);
    custom.preload = 'auto';
    audioBank = [custom]; // now all pings use the uploaded sound
    toast('üéµ Custom sound armed', 'warn');
  });

  // ==== Utils ====
  function toast(msg, tone='muted', t=1800){
    const d = document.createElement('div');
    d.className = `toast ${tone}`;
    d.textContent = msg;
    els.toasts.appendChild(d);
    setTimeout(()=>{ d.remove(); }, t);
  }
  function iou(a,b){
    const x1 = Math.max(a.x, b.x), y1 = Math.max(a.y, b.y);
    const x2 = Math.min(a.x+a.w, b.x+b.w), y2 = Math.min(a.y+a.h, b.y+b.h);
    const inter = Math.max(0,x2-x1) * Math.max(0,y2-y1);
    const ua = a.w*a.h + b.w*b.h - inter;
    return ua <= 0 ? 0 : inter/ua;
  }
  function centerInside(a,b){
    const cx = a.x + a.w/2, cy = a.y + a.h/2;
    return (cx>=b.x && cx<=b.x+b.w && cy>=b.y && cy<=b.y+b.h);
  }

  // ==== Camera ====
  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    els.cameras.innerHTML = '';
    cams.forEach((c,i) => {
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || `Camera ${i+1}`;
      els.cameras.appendChild(opt);
    });
  }
  async function startCamera(){
    stopCamera();
    const deviceId = els.cameras.value || undefined;
    stream = await navigator.mediaDevices.getUserMedia({
      video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:'environment'},
      audio: false
    });
    els.video.srcObject = stream;
    await els.video.play();
    els.overlay.width = els.video.videoWidth;
    els.overlay.height = els.video.videoHeight;
    running = true;
    loop();
  }
  function stopCamera(){
    running = false;
    cancelAnimationFrame(animId);
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    ctx.clearRect(0,0,els.overlay.width, els.overlay.height);
  }

  // ==== Model ====
  async function loadModel(){
    els.status.textContent = 'Loading COCO-SSD model‚Ä¶';
    model = await cocoSsd.load({base:'lite_mobilenet_v2'});
    els.status.textContent = 'Model ready';
    els.status.className = 'ok';
    toast('üß† Model loaded. Pretend it‚Äôs YOLO.', 'ok', 2000);
  }

  // ==== Loop ====
  async function loop(){
    if(!running || !model){ animId = requestAnimationFrame(loop); return; }
    const preds = await model.detect(els.video);
    draw(preds);
    animId = requestAnimationFrame(loop);
    // FPS calc
    frames++; const now = performance.now();
    if(now - lastT > 1000){ els.fps.textContent = frames; frames = 0; lastT = now; }
    if (els.annoy.checked && Math.random() < 0.02) toast('Pro-tip: turn it off and on again.', 'muted', 1200);
  }

  function draw(preds){
    // Hostile UX: reversed slider visually, but value is still the same; so we just use it directly.
    const confThr = parseFloat(els.conf.value);
    cooldown = parseInt(els.cool.value);
    els.confv.textContent = confThr.toFixed(2);
    els.coolv.textContent = (cooldown/1000).toFixed(1)+'s';
    ctx.clearRect(0,0,els.overlay.width, els.overlay.height);

    const persons = [], chairs = [];
    preds.forEach(p => {
      if (p.score < confThr) return;
      const [x,y,w,h] = p.bbox;
      const box = {x,y,w,h,score:p.score,class:p.class};
      if(p.class === 'person') persons.push(box);
      if(p.class === 'chair' || p.class === 'couch') chairs.push(box);
    });

    let empty = 0, occupied = 0;
    chairs.forEach(ch => {
      let occ = false;
      for(const pe of persons){
        if (iou(ch,pe) >= 0.25 || centerInside(pe, ch)) { occ = true; break; }
      }
      if(occ){ drawBox(ch,'occupied'); occupied++; } else { drawBox(ch,'empty'); empty++; }
    });
    persons.forEach(pe => drawBox(pe,'person'));
    els.emptyCount.textContent = empty;
    els.occCount.textContent = occupied;
    els.personCount.textContent = persons.length;

    if (occupied > 0) playPing(); // ping on occupied chairs
  }

  function drawBox(b,type){
    ctx.save();
    const col = type==='empty' ? '#57dba1' : type==='occupied' ? '#ff6b6b' : '#60a5fa';
    ctx.strokeStyle = col; ctx.lineWidth = 3;
    ctx.strokeRect(b.x,b.y,b.w,b.h);
    ctx.fillStyle = 'rgba(0,0,0,.6)';
    ctx.fillRect(b.x, b.y-20, 140, 20);
    ctx.fillStyle = col;
    ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
    const txt = type==='person' ? 'person' : (type==='empty'?'empty chair':'occupied chair');
    ctx.fillText(`${txt} ${(b.score*100|0)}%`, b.x+6, b.y-6);
    ctx.restore();
  }

  // ==== UI Shenanigans ====
  // Start requires consent + 2 clicks + a modal confirm, because points.
  els.start.addEventListener('click', async ()=>{
    unlockAudio();
    if(!els.consent.checked){ toast('Please agree to our EULV about chairs.', 'err', 1800); return; }
    startClicks++;
    if(startClicks === 1){ toast('Click again to really start.', 'warn'); return; }
    // modal confirm
    showModal().then(async ()=>{
      try{
        if(!model) await loadModel();
        await listCameras();
        await startCamera();
        toast('üé¨ Scanning commenced.', 'ok');
      }catch(e){
        console.error(e); els.status.textContent = 'Camera error'; els.status.className='err';
        alert('Could not access camera. If using Chrome, run from http://localhost (not file://). Try: python3 -m http.server');
      }
    }).catch(()=>{ startClicks = 0; toast('Start canceled via triple-confirm.', 'muted'); });
  });

  els.stop.addEventListener('click', ()=>{
    stopCamera(); startClicks = 0;
    toast('üõë Mission aborted.', 'warn');
  });

  els.mute.addEventListener('click', ()=>{
    muted = !muted; els.mute.textContent = muted ? 'Unmute (Louder)' : 'Mute (?)';
    toast(muted ? 'ü§´ Silence acquired.' : 'üîä Chaos restored.', muted ? 'muted' : 'ok');
  });

  els.snapshot.addEventListener('click', ()=>{
    const tmp = document.createElement('canvas');
    tmp.width = els.overlay.width; tmp.height = els.overlay.height;
    const c = tmp.getContext('2d');
    c.drawImage(els.video, 0,0,tmp.width,tmp.height);
    c.drawImage(els.overlay, 0,0);
    const url = tmp.toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='seat-sonar-evidence.png'; a.click();
    toast('üì∏ Evidence secured.', 'ok');
  });

  els.annoy.addEventListener('change', ()=>{
    const jig = v => v ? 'shaky' : '';
    els.start.classList.toggle('shaky', els.annoy.checked);
    els.stop.classList.toggle('shaky', els.annoy.checked);
    toast(els.annoy.checked ? 'Annoy Mode ENABLED. You asked for this.' : 'Annoy Mode disabled. Boring.', 'warn');
  });

  els.invert.addEventListener('change', ()=>{
    const f = els.invert.checked ? 'invert(1) hue-rotate(180deg)' : 'none';
    els.video.style.filter = f; toast(els.invert.checked?'Night Vision: ON':'Night Vision: OFF','muted');
  });

  window.addEventListener('keydown', (e)=>{
    if(e.key==='s'||e.key==='S'){ if(running) els.stop.click(); else els.start.click(); }
    if(e.key==='q'||e.key==='Q'){ els.mute.click(); }
    if(e.code==='Space'){ e.preventDefault(); playPing(); }
    if(e.key==='f'||e.key==='F'){ document.documentElement.requestFullscreen?.(); }
  });

  if (navigator.mediaDevices?.enumerateDevices) {
    navigator.mediaDevices.enumerateDevices().then(()=>listCameras()).catch(()=>{});
  }

  // Modal helpers
  function showModal(){
    return new Promise((resolve,reject)=>{
      els.modalBack.style.display = 'flex';
      const ok = ()=>{ cleanup(); resolve(); };
      const cancel = ()=>{ cleanup(); reject(); };
      function cleanup(){
        els.modalBack.style.display = 'none';
        els.mOk.removeEventListener('click', ok);
        els.mCancel.removeEventListener('click', cancel);
      }
      els.mOk.addEventListener('click', ok);
      els.mCancel.addEventListener('click', cancel);
    });
  }
})();
</script>
</body>
</html>
