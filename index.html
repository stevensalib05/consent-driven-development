<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weldon Seat Sonar ‚Äî Hostile UX + Tall Reels</title>
<style>
  :root{
    --bg:#0b1117; --card:#0f1822; --muted:#2a3a47; --text:#cfe6ff;
    --green:#57dba1; --red:#ff6b6b; --yellow:#ffd166; --blue:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;z-index:3;background:#0d1420cc;backdrop-filter:blur(6px);
    border-bottom:1px solid #0f1a26}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
  h1{margin:0;font-size:clamp(18px,2.4vw,24px);letter-spacing:.2px}
  .badge{font-size:12px;border:1px dashed var(--muted);padding:4px 8px;border-radius:999px;opacity:.8}
  .marq{white-space:nowrap;overflow:hidden;border-top:1px dashed #1a2a3a}
  .marq span{display:inline-block;padding:6px 0;animation:marq 16s linear infinite;color:#8fb8ff}
  @keyframes marq{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  main{max-width:1400px;margin:16px auto 90px;padding:0 14px}
  .grid{display:grid;grid-template-columns:1fr 520px;gap:18px}
  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border:1px solid #14202b;border-radius:16px;
        box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .pane{padding:14px}
  video,canvas{width:100%;height:auto;display:block;background:#000;border-bottom:1px solid #233142}
  .legend{display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px;border-top:1px dashed #233242}
  .chip{display:inline-flex;gap:8px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #253645;background:#17222d;font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.green{background:var(--green)} .dot.red{background:var(--red)} .dot.blue{background:var(--blue)}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px;border-top:1px solid #172532;background:#0e1620;position:relative}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#18232e;border:1px solid #253645;border-radius:999px;padding:6px 10px}
  label.small{font-size:12px;opacity:.85}
  button,select{background:#1a2630;color:var(--text);border:1px solid #2a3a47;border-radius:10px;padding:8px 12px;cursor:pointer}
  button:hover{background:#223140} button.primary{background:#254055;border-color:#2f536d}
  input[type="range"]{accent-color:#6fc5ff}
  .reverse{transform:scaleX(-1)} .reverse + span{user-select:none}
  .floaty{position:absolute;right:10px;top:-12px;background:#15202b;border:1px solid #243545;padding:6px 10px;border-radius:8px;font-size:12px;animation:float 6s ease-in-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(10px)}100%{transform:translateY(0)}}
  #toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:5}
  .toast{background:#0e1622;border:1px solid #213244;border-radius:12px;padding:10px 12px;min-width:220px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .ok{color:var(--green)} .warn{color:var(--yellow)} .err{color:var(--red)} .muted{opacity:.65}
  footer{position:fixed;bottom:0;left:0;right:0;padding:10px 14px;background:#0a0f14e0;backdrop-filter:blur(8px);
    border-top:1px solid #12202c;display:flex;gap:12px;justify-content:center}
  .kbd{background:#111a22;border:1px solid #2a3a47;border-radius:6px;padding:0 6px;font-size:12px}

  /* ===== Reels: tall, one-per-screen, snap scroll ===== */
  #reelsCard{position:sticky;top:74px;height:calc(100vh - 100px)}
  #reelsPanel{
    height:100%; overflow-y:auto; overflow-x:hidden; scroll-snap-type:y mandatory;
    display:flex; flex-direction:column; gap:0; scrollbar-width:thin; scrollbar-color:#2a3a47 transparent;
  }
  #reelsPanel::-webkit-scrollbar{width:6px}
  #reelsPanel::-webkit-scrollbar-track{background:transparent}
  #reelsPanel::-webkit-scrollbar-thumb{background:#2a3a47;border-radius:3px}
  .reel{
    position:relative; width:100%; min-height:100%; flex-shrink:0;
    border-radius:0; overflow:hidden; scroll-snap-align:start; scroll-snap-stop:always;
    background:#000; transition:opacity .2s;
  }
  .reel video{
    width:100%; height:100%; object-fit:cover; display:block;
    filter:contrast(1.06) saturate(1.15);
  }
  .reel.loading{opacity:.3}
  .progress{
    position:absolute; top:0; left:0; right:0; height:3px; background:#0003; z-index:2;
  }
  .progress-bar{
    height:100%; background:linear-gradient(90deg, #60a5fa, #57dba1); width:0%; transition:width .1s linear;
  }
  .cap{
    position:absolute; left:14px; bottom:80px; right:70px; color:#fff; font-size:13px; z-index:1;
    text-shadow:0 2px 8px rgba(0,0,0,.8);
  }
  .cap-title{font-weight:600; margin-bottom:4px; font-size:14px}
  .cap-author{opacity:.85; font-size:12px}
  .sideBtns{
    position:absolute; right:14px; bottom:20px; display:flex; flex-direction:column; gap:12px; z-index:1;
  }
  .iconBtn{
    width:48px; height:48px; border-radius:50%; border:none;
    background:#17232ecc; backdrop-filter:blur(8px); color:#fff; display:flex; flex-direction:column;
    align-items:center; justify-content:center; font-size:20px; cursor:pointer; transition:all .2s;
    box-shadow:0 4px 12px rgba(0,0,0,.3);
  }
  .iconBtn:hover{background:#1f3647; transform:scale(1.08)}
  .iconBtn small{font-size:10px; margin-top:2px; font-weight:600}
  .tag{
    position:absolute; top:14px; left:14px; background:#17232ecc; backdrop-filter:blur(8px);
    color:#fff; border-radius:999px; padding:7px 12px; font-size:11px; font-weight:600;
    text-transform:uppercase; letter-spacing:.5px; z-index:1;
  }
  .loader{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:40px; height:40px; border:3px solid #2a3a47; border-top-color:#60a5fa;
    border-radius:50%; animation:spin 1s linear infinite; z-index:2;
  }
  @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
</style>

<!-- TensorFlow.js + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
</head>
<body>
<header>
  <div class="bar">
    <h1>Weldon Seat Sonar <span class="badge">Hostile UX Edition‚Ñ¢</span></h1>
    <div class="row muted">Pings when it sees <b>occupied chairs</b>. Probably.</div>
  </div>
  <div class="marq"><span>Tip: point at a chair ‚Ä¢ Camera stays on-device ‚Ä¢ If anything breaks, it's a feature ‚Ä¢ J/K or ‚Üë/‚Üì to change reels, M to mute, L to like</span></div>
</header>

<main class="grid">
  <!-- LEFT: camera + overlay -->
  <section class="card">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div class="legend">
      <span class="chip"><span class="dot green"></span> empty chair</span>
      <span class="chip"><span class="dot red"></span> occupied chair</span>
      <span class="chip"><span class="dot blue"></span> person</span>
      <span class="chip muted">FPS: <span id="fps">0</span></span>
      <span class="chip muted">Model: COCO-SSD</span>
    </div>
    <div class="controls">
      <div class="floaty">Start requires <b>two</b> clicks. For safety.</div>
      <input type="checkbox" id="consent">
      <label for="consent" class="small">I solemnly swear this camera points at chairs*</label>
      <button id="start" class="primary">Do Not Press</button>
      <button id="stop">Abort Mission</button>
      <select id="cameras" title="mystery camera"></select>

      <div class="pill">
        <label class="small">Confidence (reversed for no reason)</label>
        <input id="conf" type="range" class="reverse" min="0.2" max="0.9" step="0.05" value="0.5" />
        <span id="confv">0.50</span>
      </div>
      <div class="pill">
        <label class="small">Dramatic pause</label>
        <input id="cool" type="range" min="500" max="5000" step="100" value="1500" />
        <span id="coolv">1.5s</span>
      </div>
      <div class="pill">
        <label class="small">Sound</label>
        <input type="file" id="sound" accept="audio/*" />
        <span class="muted small">defaults to sonar.mp3</span>
      </div>
      <button id="mute">Mute</button>
      <button id="snapshot">Take Evidence</button>
      <div class="pill">
        <label class="small">Night Vision</label>
        <input type="checkbox" id="invert">
      </div>
    </div>
  </section>

  <!-- RIGHT: tall reels -->
  <section class="card pane" id="reelsCard">
    <h3 style="margin:6px 2px 10px">Study Reels <span style="opacity:.6;font-size:12px">(swipe/scroll ‚Ä¢ J/K keys)</span></h3>
    <div id="reelsPanel">
      <div class="reel loading"><div class="loader"></div></div>
    </div>
  </section>
</main>

<footer class="muted">
  Keys: <span class="kbd">S</span> start/stop ‚Ä¢ <span class="kbd">Q</span> mute/unmute ‚Ä¢ <span class="kbd">Space</span> ping ‚Ä¢ <span class="kbd">F</span> fullscreen ‚Ä¢ <span class="kbd">J/K</span> next/prev reel
</footer>

<div id="toasts"></div>

<script>
(() => {
  /* =========================
     HARD-CODED PEXELS API KEY
  ========================== */
  const PEXELS_KEY = "fT6wmK0pwLddKDyuQUU3I93FnBmVqjCpTWny8KbMTHo3eV2S3ecJwSCt";

  /* =========================
     Elements & state (camera)
  ========================== */
  const els = {
    video: document.getElementById('video'),
    overlay: document.getElementById('overlay'),
    start: document.getElementById('start'),
    stop: document.getElementById('stop'),
    cameras: document.getElementById('cameras'),
    conf: document.getElementById('conf'),
    confv: document.getElementById('confv'),
    cool: document.getElementById('cool'),
    coolv: document.getElementById('coolv'),
    sound: document.getElementById('sound'),
    mute: document.getElementById('mute'),
    snapshot: document.getElementById('snapshot'),
    fps: document.getElementById('fps'),
    consent: document.getElementById('consent'),
    invert: document.getElementById('invert'),
    toasts: document.getElementById('toasts'),
    reelsPanel: document.getElementById('reelsPanel'),
  };

  let model = null, stream = null, running = false, ctx = els.overlay.getContext('2d');
  let muted = false, lastPing = 0, cooldown = 1500, startClicks = 0;
  let animId = 0, lastT = performance.now(), frames = 0;
  let audioUnlocked = false;

  // ==== Audio ====
  // List of default sounds in /audio
  const soundFiles = [
    'audio/fahhh.mp3',
    'audio/metal-pipe.mp3',
    'audio/oof.mp3',
    'audio/sonar.mp3',
    'audio/vine-boom.mp3',
    'audio/67.mp3',
    'audio/job.mp3',
    'audio/mogus.mp3',
    'audio/social-credit.mp3',
    'audio/steve-oof.mp3',
    'audio/discord-ping.mp3',
    'audio/airhorn.mp3', 
    'audio/sudden.mp3', 
    'audio/suspense.mp3', 
    'audio/r2d2.mp3',
    'audio/bruh.mp3',
    'audio/mgs.mp3', 
    'audio/FBI.mp3',
    // add more here as needed
  ];

  // Turn them into Audio objects
  let audioBank = soundFiles.map(src => {
    const a = new Audio(src);
    a.preload = 'auto';
    return a;
  });
  
  function unlockAudio(){
    if (audioUnlocked) return;
    audioUnlocked = true;

    // Prime ALL sounds (for iOS/Safari weirdness)
    audioBank.forEach(a => {
      a.volume = 1;
      a.play()
        .then(() => {
          a.pause();
          a.currentTime = 0;
          a.volume = 10;
        })
        .catch(() => { /* shrug */ });
    });
  }

  function getRandomAudio() {
    if (!audioBank.length) return null;
    return audioBank[Math.floor(Math.random() * audioBank.length)];
  }

  function playPing(){
    if (muted) return;
    const now = performance.now();
    if (now - lastPing < cooldown) return;
    lastPing = now;

    const base = getRandomAudio();
    if (base) {
      const instance = base.cloneNode(true);
      // optional extra chaos:
      instance.playbackRate = 0.8 + Math.random() * 0.6;
      
      instance.play().catch(() => synthPing());
    } else {
      synthPing();
    }

    toast('üîî Occupied chair detected', 'ok');
  }

  function synthPing(){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    const ac = new Ctx();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = 'sine'; 
    o.frequency.setValueAtTime(900, ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(500, ac.currentTime + 0.18);
    g.gain.setValueAtTime(0.05, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.18);
    o.connect(g).connect(ac.destination);
    o.start(); 
    o.stop(ac.currentTime + 0.18);
  }

  // File input: replaces bank with a single custom sound
  els.sound.addEventListener('change', () => {
    const file = els.sound.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const custom = new Audio(url);
    custom.preload = 'auto';
    audioBank = [custom]; // now all pings use the uploaded sound
    toast('üéµ Custom sound armed', 'warn');
  });

  /* =============== Utils =============== */
  function toast(msg, tone='muted', t=1800){
    const d = document.createElement('div'); d.className = `toast ${tone}`; d.textContent = msg;
    els.toasts.appendChild(d); setTimeout(()=>d.remove(), t);
  }
  function iou(a,b){
    const x1 = Math.max(a.x, b.x), y1 = Math.max(a.y, b.y);
    const x2 = Math.min(a.x+a.w, b.x+b.w), y2 = Math.min(a.y+a.h, b.y+b.h);
    const inter = Math.max(0,x2-x1) * Math.max(0,y2-y1);
    const ua = a.w*a.h + b.w*b.h - inter; return ua<=0?0:inter/ua;
  }
  function centerInside(a,b){
    const cx = a.x + a.w/2, cy = a.y + a.h/2;
    return (cx>=b.x && cx<=b.x+b.w && cy>=b.y && cy<=b.y+b.h);
  }

  /* ============ Camera / Model ============ */
  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    els.cameras.innerHTML = ''; cams.forEach((c,i) => {
      const opt = document.createElement('option'); opt.value = c.deviceId;
      opt.textContent = c.label || `Camera ${i+1}`; els.cameras.appendChild(opt);
    });
  }
  async function startCamera(){
    stopCamera();
    const deviceId = els.cameras.value || undefined;
    stream = await navigator.mediaDevices.getUserMedia({
      video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:'environment'}, audio:false
    });
    els.video.srcObject = stream; await els.video.play();
    els.overlay.width = els.video.videoWidth; els.overlay.height = els.video.videoHeight;
    running = true; loop();
  }
  function stopCamera(){
    running = false; cancelAnimationFrame(animId);
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    ctx.clearRect(0,0,els.overlay.width, els.overlay.height);
  }
  async function loadModel(){
    model = await cocoSsd.load({base:'lite_mobilenet_v2'});
    toast('üß† Model ready','ok',1500);
  }
  async function loop(){
    if(!running || !model){ animId = requestAnimationFrame(loop); return; }
    const preds = await model.detect(els.video); draw(preds);
    animId = requestAnimationFrame(loop);
    frames++; const now = performance.now();
    if(now - lastT > 1000){ lastT = now; frames = 0; }
  }
  function draw(preds){
    const confThr = parseFloat(els.conf.value); cooldown = parseInt(els.cool.value);
    ctx.clearRect(0,0,els.overlay.width, els.overlay.height);
    const persons=[], chairs=[];
    preds.forEach(p=>{
      if(p.score<confThr) return;
      const [x,y,w,h] = p.bbox; const box={x,y,w,h,score:p.score,class:p.class};
      if(p.class==='person') persons.push(box);
      if(p.class==='chair'||p.class==='couch') chairs.push(box);
    });
    let occupied=0;
    chairs.forEach(ch=>{
      let occ=false; for(const pe of persons){ if(iou(ch,pe)>=0.25||centerInside(pe,ch)){ occ=true; break; } }
      drawBox(ch, occ?'occupied':'empty'); if(occ) occupied++;
    });
    persons.forEach(pe=>drawBox(pe,'person'));
    if(occupied>0) playPing();
  }
  function drawBox(b,type){
    const col = type==='empty' ? '#57dba1' : type==='occupied' ? '#ff6b6b' : '#60a5fa';
    ctx.strokeStyle = col; ctx.lineWidth = 3; ctx.strokeRect(b.x,b.y,b.w,b.h);
    ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(b.x,b.y-20,140,20);
    ctx.fillStyle=col; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
    const txt = type==='person'?'person':(type==='empty'?'empty chair':'occupied chair');
    ctx.fillText(`${txt} ${(b.score*100|0)}%`, b.x+6, b.y-6);
  }

  els.start.addEventListener('click', async ()=>{
    unlockAudio();
    if(!els.consent.checked){ toast('Please agree to the EULV about chairs.','err'); return; }
    startClicks++; if(startClicks===1){ toast('Click again to really start.','warn'); return; }
    try{ if(!model) await loadModel(); await listCameras(); await startCamera(); toast('üé¨ Scanning','ok'); }
    catch(e){ console.error(e); alert('Camera error. Serve from http://localhost (python3 -m http.server)'); }
  });
  els.stop.addEventListener('click', ()=>{ stopCamera(); startClicks=0; toast('üõë Stopped','warn'); });
  els.mute.addEventListener('click', ()=>{ muted=!muted; els.mute.textContent = muted?'Unmute':'Mute'; });
  els.snapshot.addEventListener('click', ()=>{
    const c=document.createElement('canvas'); c.width=els.overlay.width; c.height=els.overlay.height;
    const d=c.getContext('2d'); d.drawImage(els.video,0,0,c.width,c.height); d.drawImage(els.overlay,0,0);
    const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='seat-sonar.png'; a.click();
  });
  els.invert.addEventListener('change', ()=>{ els.video.style.filter = els.invert.checked?'invert(1) hue-rotate(180deg)':'none'; });
  window.addEventListener('keydown',(e)=>{
    if(e.key==='s'||e.key==='S'){ if(running) els.stop.click(); else els.start.click(); }
    if(e.key==='q'||e.key==='Q'){ els.mute.click(); }
    if(e.code==='Space'){ e.preventDefault(); playPing(); }
    if(e.key==='j'||e.key==='J'||e.key==='ArrowDown'){ jump(1); }
    if(e.key==='k'||e.key==='K'||e.key==='ArrowUp'){ jump(-1); }
    if(e.key==='m'||e.key==='M'){ if(activeVideo){ activeVideo.muted=!activeVideo.muted; } }
    if(e.key==='l'||e.key==='L'){ if(activeLike){ activeLike.dataset.n = (+activeLike.dataset.n||0)+1; activeLike.innerHTML = `‚ù§<small>${activeLike.dataset.n}</small>`; } }
  });
  if (navigator.mediaDevices?.enumerateDevices) navigator.mediaDevices.enumerateDevices().then(()=>listCameras()).catch(()=>{});

  /* ============ REELS (portrait, snap, ‚Äúentertainment mode‚Äù) ============ */
  const FUN_QUERIES = [
    'study library','coffee shop ambience','campus life','cozy reading',
    'productivity','student life','modern office','workspace aesthetic',
    'minimalist desk','book collection','typing keyboard','lofi study',
    'rain window','city timelapse','nature relax','morning routine'
  ];
  const reelsState = { 
    page:1, perPage:8, loading:false, eof:false,
    query: new URL(location.href).searchParams.get('q') || null,
    funIndex: 0
  };

  let activeVideo=null, activeLike=null, activeReel=null, progressInterval=null;

  // Autoplay/pause when 50% visible
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      const v = e.target.querySelector('video'); if(!v) return;
      const likeBtn = e.target.querySelector('[data-like]');
      const progressBar = e.target.querySelector('.progress-bar');
      if (e.isIntersecting && e.intersectionRatio>=0.5){
        if(activeVideo && activeVideo!==v){ activeVideo.pause(); activeVideo.currentTime=0; }
        if(progressInterval) clearInterval(progressInterval);
        activeVideo=v; activeLike=likeBtn; activeReel=e.target;
        v.play().catch(()=>{});
        e.target.classList.add('active'); e.target.classList.remove('loading');
        if(progressBar){
          progressInterval = setInterval(()=>{
            if(!v.duration) return;
            const pct = (v.currentTime / v.duration) * 100;
            progressBar.style.width = pct + '%';
            if(pct>=99.5){ progressBar.style.width='0%'; v.currentTime=0; }
          }, 100);
        }
      } else {
        v.pause(); e.target.classList.remove('active');
        if(progressBar) progressBar.style.width='0%';
      }
    });
  }, { root: els.reelsPanel, threshold: [0, .5, 1] });

  function pickBestFile(files){
    // Prefer vertical (‚âà9:16) and at least 720px tall
    let best=null, bestScore=1e9;
    files.filter(f=>/mp4/i.test(f.file_type||'')).forEach(f=>{
      const w=f.width||0, h=f.height||1, r=w/h; const score=Math.abs(r-0.5625) + (h<720?1:0);
      if(score<bestScore){ best=f; bestScore=score; }
    });
    return best || files.sort((a,b)=>(b.height||0)-(a.height||0))[0] || files[0];
  }

  function makeReel({src, caption, author, tag, id}){
    const wrap=document.createElement('div'); wrap.className='reel loading'; wrap.dataset.id=id;

    const loader=document.createElement('div'); loader.className='loader'; wrap.appendChild(loader);

    const v=document.createElement('video'); 
    v.src=src; v.loop=true; v.muted=true; v.playsInline=true; v.preload='metadata';
    v.addEventListener('loadeddata', ()=>{ wrap.classList.remove('loading'); loader.remove(); });
    wrap.appendChild(v);

    const prog=document.createElement('div'); prog.className='progress';
    const bar=document.createElement('div'); bar.className='progress-bar';
    prog.appendChild(bar); wrap.appendChild(prog);

    const topTag=document.createElement('div'); topTag.className='tag'; topTag.textContent=tag||'Pexels';
    wrap.appendChild(topTag);

    const cap=document.createElement('div'); cap.className='cap';
    if(caption){ const t=document.createElement('div'); t.className='cap-title'; t.textContent=caption; cap.appendChild(t); }
    if(author){ const a=document.createElement('div'); a.className='cap-author'; a.textContent='by '+author; cap.appendChild(a); }
    wrap.appendChild(cap);

    const side=document.createElement('div'); side.className='sideBtns';
    const like=document.createElement('button'); like.className='iconBtn'; like.innerHTML='‚ù§<small>0</small>'; like.dataset.like=''; like.dataset.n='0';
    like.onclick=()=>{ const n=(+like.dataset.n||0)+1; like.dataset.n=n; like.innerHTML=`‚ù§<small>${n}</small>`; };
    const share=document.createElement('button'); share.className='iconBtn'; share.innerHTML='üì§<small></small>';
    share.onclick=()=>{ (navigator.share ? navigator.share({title:caption||'Reel', url:src}) : navigator.clipboard.writeText(src).then(()=>{})).catch(()=>{}); };
    const mute=document.createElement('button'); mute.className='iconBtn'; mute.innerHTML='üîá<small></small>';
    mute.onclick=()=>{ v.muted=!v.muted; mute.innerHTML=v.muted?'üîá<small></small>':'üîä<small></small>'; };
    side.append(like,share,mute);
    wrap.appendChild(side);

    els.reelsPanel.appendChild(wrap);
    io.observe(wrap);
    return wrap;
  }

  async function fetchPexels(url){
    const res = await fetch(url, { headers:{ Authorization: PEXELS_KEY }});
    if(!res.ok) throw new Error('Pexels '+res.status);
    return res.json();
  }

  function addClips(json, tagLabel){
    const vids=json.videos||[]; if(!vids.length){ reelsState.eof=true; return; }
    vids.forEach(v=>{
      const files = v.video_files || [];
      const best = pickBestFile(files);
      if(!best?.link) return;
      makeReel({
        src: best.link,
        caption: (v.id ? 'Clip #' + v.id : '') || '',
        author: v.user?.name || 'Pexels',
        tag: tagLabel || 'Pexels',
        id: v.id
      });
    });
  }

  function nextQuery(){
    if (reelsState.query) return { q: reelsState.query, tag: reelsState.query };
    const q = FUN_QUERIES[reelsState.funIndex % FUN_QUERIES.length];
    reelsState.funIndex++; return { q, tag:q };
  }

  async function loadNext(){
    if(reelsState.loading || reelsState.eof) return;
    reelsState.loading=true;
    try{
      const { q, tag } = nextQuery();
      const url=`https://api.pexels.com/videos/search?query=${encodeURIComponent(q)}&per_page=${reelsState.perPage}&page=${reelsState.page++}`;
      const data = await fetchPexels(url);
      addClips(data, tag);
    }catch(e){
      console.error(e);
      // Minimal fallback if Pexels is unavailable
      makeReel({ src:'https://www.w3schools.com/html/mov_bbb.mp4', caption:'Sample (fallback)', author:'W3Schools', tag:'Fallback', id:'fallback-'+Date.now() });
      reelsState.eof = true;
    }finally{
      reelsState.loading=false;
    }
  }

  // Infinite scroll trigger
  els.reelsPanel.addEventListener('scroll', ()=>{
    const el = els.reelsPanel;
    if(el.scrollTop + el.clientHeight >= el.scrollHeight - 160) loadNext();
  });

  // Keyboard jump between reels
  function jump(dir){
    const cards=[...els.reelsPanel.querySelectorAll('.reel')];
    const idx=cards.findIndex(c=>c.classList.contains('active'));
    let next = Math.max(0, Math.min(cards.length-1, (idx<0?0:idx)+dir));
    cards[next]?.scrollIntoView({behavior:'smooth', block:'start'});
  }

  // Seed with two pages for smoothness
  loadNext(); loadNext();
})();
</script>
</body>
</html>
